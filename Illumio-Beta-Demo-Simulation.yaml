# use ami-09cb21a1e29bcebf0 as a default for eu-central-1
# alexgoller - add parameters for Region and DefaultAMI
# AMI id may change according to region

AWSTemplateFormatVersion: "2010-09-09"
Description: "Illumio CS Free Trial"
Parameters:
  Region:
    Type: String
    Default: us-east-1
  DefaultAMI:
    Type: String
    Default: "ami-01c647eace872fc02"

Resources:
#-----VPC and subnet creation-----
  ACMEVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: "10.0.0.0/16"
      EnableDnsHostnames: true
      EnableDnsSupport: true
      InstanceTenancy: "default"
      Tags:
        - Key: "Name"
          Value: "ACME-VPC"

  ProdSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Sub "${Region}a"
      CidrBlock: "10.0.1.0/24"
      VpcId: !Ref ACMEVPC
      MapPublicIpOnLaunch: true
      Tags:
        - Key: "Name"
          Value: "Production Subnet"

  StagingSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Sub "${Region}a"
      CidrBlock: "10.0.2.0/24"
      VpcId: !Ref ACMEVPC
      MapPublicIpOnLaunch: true
      Tags:
        - Key: "Name"
          Value: "Staging Subnet"

  DevSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Sub "${Region}a"
      CidrBlock: "10.0.3.0/24"
      VpcId: !Ref ACMEVPC
      MapPublicIpOnLaunch: true
      Tags:
        - Key: "Name"
          Value: "Dev Subnet"

#------Internet gateway----------
  ACMEIG:
    Type: AWS::EC2::InternetGateway
    Properties: 
      Tags: 
        - Key: "Name"
          Value: "InternetGateway"

  AttachIG:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties: 
      InternetGatewayId: !Ref ACMEIG
      VpcId: !Ref ACMEVPC

#------NAT Gateway------------
  ACMENG:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt ACMENGEIP.AllocationId
      SubnetId: !Ref ProdSubnet
      Tags:
      - Key: "Name"
        Value: "NATGateway"

  ACMENGEIP:
    DependsOn: ACMEVPC
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

#-----Public Route--------
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ACMEVPC
      Tags:
      - Key: "Name"
        Value: "PublicRouteTable"

  PublicRoute1:   # Public route table has direct routing to IGW:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref ACMEIG 

  PublicSubnetRouteAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: 
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref ProdSubnet

#---------Private Routes-----------
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ACMEVPC
      Tags:
      - Key: "Name"
        Value: "PrivateRouteTable"

  PrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId: !Ref ACMENG

  PrivateAppSubnetRouteAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: 
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref DevSubnet

  PrivateAppSubnetRouteAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: 
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref StagingSubnet

#------------Apps within Prod Subnet----------------
#------------CRM Prod App--------------------------------
#------------CRMEC2Web------------------------------

  CRMEC2Web1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt ProdSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref ProdSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref CRMPublicWebSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          sudo yum install python3-pip -y
          sudo pip3 install boto3
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Complex/createtable.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Add_multiple_items.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/dynamoscan.py -P /home/ec2-user
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${CRMEC2Proc1.PrivateIp} 5000 -t 10 >> /tmp/Proc1.log") | crontab -
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${CRMEC2Proc2.PrivateIp} 5000 -t 10 >> /tmp/Proc2.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Prod"
      - Key: "Asset"
        Value: "CRM"
      - Key: "Name"
        Value: "CRM-Prod-Web1"

  CRMEC2Web2:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt ProdSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref ProdSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref CRMPublicWebSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          sudo yum install python3-pip -y
          sudo pip3 install boto3
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Complex/createtable.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Add_multiple_items.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/dynamoscan.py -P /home/ec2-user
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${CRMEC2Proc1.PrivateIp} 5000 -t 10 >> /tmp/Proc1.log") | crontab -
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${CRMEC2Proc2.PrivateIp} 5000 -t 10 >> /tmp/Proc2.log") | crontab -
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${FinanceEC2Web1.PrivateIp} 80 -t 10 >> /tmp/Web1.log") | crontab -
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${FinanceEC2Proc1.PrivateIp} 5000 -t 10 >> /tmp/FinProc2.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Prod"
      - Key: "Asset"
        Value: "CRM"
      - Key: "Name"
        Value: "CRM-Prod-Web2"

#------------CRMEC2ProcTiers------------------
  CRMEC2Proc1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt ProdSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref ProdSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref CRMAppPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 5000; done &
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${CRMEC2DB1.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Prod"
      - Key: "Asset"
        Value: "CRM"
      - Key: "Name"
        Value: "CRM-Prod-Proc1"

  CRMEC2Proc2:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt ProdSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref ProdSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref CRMAppPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 5000; done &
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${CRMEC2DB1.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Prod"
      - Key: "Asset"
        Value: "CRM"
      - Key: "Name"
        Value: "CRM-Prod-Proc2"


#-------------CRM DB------------------

  CRMEC2DB1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt ProdSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref ProdSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref CRMDBPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 3306; done &
      Tags:
      - Key: "Env"
        Value: "Prod"
      - Key: "Asset"
        Value: "CRM"
      - Key: "Name"
        Value: "CRM-Prod-DB1"

#---------CRM Security groups----------

  CRMPublicWebSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "CRM PublicWebSG "
      GroupName: "CRMWebTierSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  CRMAppPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "CRM AppPrivateSG "
      GroupName: "CRMAppPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  CRMDBPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "CRM DBPrivateSG "
      GroupName: "CRMDBPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

#------------Finance App----------------------
#------------Finance EC2Web------------------
  FinanceEC2Web1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt ProdSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref ProdSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref FinancePublicWebSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          sudo yum install python3-pip -y
          sudo pip3 install boto3
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Complex/createtable.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Add_multiple_items.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/dynamoscan.py -P /home/ec2-user
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${FinanceEC2Proc1.PrivateIp} 5000 -t 10 >> /tmp/Proc1.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Prod"
      - Key: "App"
        Value: "Finance"
      - Key: "APP-ID"
        Value: "Fin-001"
      - Key: "Name"
        Value: "Finance-Prod-Web1"

  FinanceEC2Web2:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt ProdSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref ProdSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref FinancePublicWebSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          sudo yum install python3-pip -y
          sudo pip3 install boto3
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Complex/createtable.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Add_multiple_items.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/dynamoscan.py -P /home/ec2-user
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${FinanceEC2Proc1.PrivateIp} 5000 -t 10 >> /tmp/Proc1.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Prod"
      - Key: "App"
        Value: "Finance"
      - Key: "APP-ID"
        Value: "Fin-001"
      - Key: "Name"
        Value: "Finance-Prod-Web2"

#------------Finance EC2ProcTiers------------------
  FinanceEC2Proc1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt ProdSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref ProdSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref FinanceAppPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 5000; done &
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${FinanceEC2DB1.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${FinanceEC2DB2.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Prod"
      - Key: "App"
        Value: "Finance"
      - Key: "APP-ID"
        Value: "Fin-002"
      - Key: "Name"
        Value: "Finance-Prod-Proc1"

#------------Finance EC2DBTiers------------------
  FinanceEC2DB1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt ProdSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref ProdSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref FinanceDBPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 3306; done &
      Tags:
      - Key: "Env"
        Value: "Prod"
      - Key: "App"
        Value: "Finance"
      - Key: "APP-ID"
        Value: "Fin-002"
      - Key: "Name"
        Value: "Finance-Prod-DB1"

  FinanceEC2DB2:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt ProdSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref ProdSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref FinanceDBPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 3306; done &
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${FinanceEC2DB1.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Prod"
      - Key: "App"
        Value: "Finance"
      - Key: "APP-ID"
        Value: "Fin-002"
      - Key: "Name"
        Value: "Finance-Prod-DB2"

#---------Finance Security groups----------

  FinancePublicWebSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "Finance PublicWebSG "
      GroupName: "FinanceWebTierSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  FinanceAppPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "Finance AppPrivateSG "
      GroupName: "FinanceAppPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  FinanceDBPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "Finance DBPrivateSG "
      GroupName: "FinanceDBPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

#------------POS App----------------------
#------------POS EC2Web------------------
  POSEC2Web1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt ProdSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref ProdSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref POSPublicWebSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          sudo yum install python3-pip -y
          sudo pip3 install boto3
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Complex/createtable.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Add_multiple_items.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/dynamoscan.py -P /home/ec2-user
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${POSEC2Proc1.PrivateIp} 5000 -t 10 >> /tmp/Proc1.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Prod"
      - Key: "App"
        Value: "POS"
      - Key: "Resource-ID"
        Value: "POS-001-001"
      - Key: "Name"
        Value: "POS-Prod-Web1"

#------------POS EC2ProcTiers------------------
  POSEC2Proc1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt ProdSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref ProdSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref POSAppPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 5000; done &
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${POSEC2DB1.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Prod"
      - Key: "App"
        Value: "POS"
      - Key: "Resource-ID"
        Value: "POS-001-002"
      - Key: "Name"
        Value: "POS-Prod-Proc1"

#------------- POS DB----------------

  POSEC2DB1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt ProdSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref ProdSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref POSDBPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 3306; done &
      Tags:
      - Key: "Env"
        Value: "Prod"
      - Key: "App"
        Value: "POS"
      - Key: "Resource-ID"
        Value: "POS-001-003"
      - Key: "Name"
        Value: "POS-Prod-DB1"

#---------POS Security groups----------

  POSPublicWebSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "POS PublicWebSG "
      GroupName: "POSWebTierSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  POSAppPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "POS AppPrivateSG "
      GroupName: "POSAppPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  POSDBPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "POS DBPrivateSG "
      GroupName: "POSDBPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

#---------Apps within Dev Subnet-------------
#------------POS Dev App----------------------
#------------POS Dev EC2Web------------------
  POSDevEC2Web1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt DevSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref DevSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref POSDevPublicWebSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          sudo yum install python3-pip -y
          sudo pip3 install boto3
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Complex/createtable.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Add_multiple_items.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/dynamoscan.py -P /home/ec2-user
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${POSDevEC2Proc1.PrivateIp} 5000 -t 10 >> /tmp/Proc1.log") | crontab -
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${POSEC2DB1.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet dropbox.com 443 -t 10 >> /tmp/dropbox.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Dev"
      - Key: "App"
        Value: "POS"
      - Key: "Resource-ID"
        Value: "POS-002-001"
      - Key: "Name"
        Value: "POS-Dev-Web1"

#------------POS Dev EC2ProcTiers------------------
  POSDevEC2Proc1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt DevSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref DevSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref POSDevAppPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 5000; done &
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${POSDevEC2DB1.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Dev"
      - Key: "App"
        Value: "POS"
      - Key: "Resource-ID"
        Value: "POS-002-002"
      - Key: "Name"
        Value: "POS-Dev-Proc1"

#------------- POS Dev Database----------------

  POSDevEC2DB1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt DevSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref DevSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref POSDevDBPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 3306; done &
      Tags:
      - Key: "Env"
        Value: "Dev"
      - Key: "App"
        Value: "POS"
      - Key: "Resource-ID"
        Value: "POS-002-003"
      - Key: "Name"
        Value: "POS-Dev-DB1"

#---------POS Dev Security groups----------

  POSDevPublicWebSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "POS Dev PublicWebSG "
      GroupName: "POSDevWebTierSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  POSDevAppPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "POS Dev AppPrivateSG "
      GroupName: "POSDevAppPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  POSDevDBPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "POS Dev DBPrivateSG "
      GroupName: "POSDevDBPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

#-------------HR App--------------
#------------HR Dev app-----------

  HRDevEC2Web1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt DevSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref DevSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref HRDevPublicWebSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          sudo yum install python3-pip -y
          sudo pip3 install boto3
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Complex/createtable.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Add_multiple_items.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/dynamoscan.py -P /home/ec2-user
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${HRDevEC2Proc1.PrivateIp} 5000 -t 10 >> /tmp/Proc1.log") | crontab -
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${POSEC2DB1.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet dropbox.com 443 -t 10 >> /tmp/dropbox.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Dev"
      - Key: "App"
        Value: "HR"
      - Key: "App-ID"
        Value: "HR-002-001"
      - Key: "Name"
        Value: "HR-Dev-Web1"

#------------HR Dev EC2ProcTiers------------------
  HRDevEC2Proc1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt DevSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref DevSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref HRDevAppPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 5000; done &
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${HRDevEC2DB1.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Dev"
      - Key: "App"
        Value: "HR"
      - Key: "App-ID"
        Value: "HR-002-002"
      - Key: "Name"
        Value: "HR-Dev-Proc1"

#------------- HR Dev Database----------------

  HRDevEC2DB1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt DevSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref DevSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref HRDevDBPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 3306; done &
      Tags:
      - Key: "Env"
        Value: "Dev"
      - Key: "App"
        Value: "HR"
      - Key: "App-ID"
        Value: "HR-002-003"
      - Key: "Name"
        Value: "HR-Dev-DB1"

#---------HR Dev Security groups----------

  HRDevPublicWebSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "HR Dev PublicWebSG "
      GroupName: "HRDevWebTierSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  HRDevAppPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "HR Dev AppPrivateSG "
      GroupName: "HRDevAppPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  HRDevDBPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "HR Dev DBPrivateSG "
      GroupName: "HRDevDBPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"


#-------------Fin Dev App--------------
#------------Fin Dev app-----------

  FinDevEC2Web1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt DevSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref DevSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref FinDevPublicWebSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          sudo yum install python3-pip -y
          sudo pip3 install boto3
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Complex/createtable.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Add_multiple_items.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/dynamoscan.py -P /home/ec2-user
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${FinDevEC2Proc1.PrivateIp} 5000 -t 10 >> /tmp/Proc1.log") | crontab -
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${POSEC2DB1.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Dev"
      - Key: "App"
        Value: "Finance"
      - Key: "Resource-ID"
        Value: "Fin-002-001"
      - Key: "Name"
        Value: "Fin-Dev-Web1"

#------------Fin Dev EC2ProcTiers------------------
  FinDevEC2Proc1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt DevSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref DevSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref FinDevAppPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 5000; done &
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${FinDevEC2DB1.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Dev"
      - Key: "App"
        Value: "Finance"
      - Key: "Resource-ID"
        Value: "Fin-002-002"
      - Key: "Name"
        Value: "Fin-Dev-Proc1"

#------------- Finance Dev Database----------------

  FinDevEC2DB1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt DevSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref DevSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref FinDevDBPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 3306; done &
      Tags:
      - Key: "Env"
        Value: "Dev"
      - Key: "App"
        Value: "Finance"
      - Key: "Resource-ID"
        Value: "Fin-002-002"
      - Key: "Name"
        Value: "Fin-Dev-Proc1"

#---------Fin Dev Security groups----------

  FinDevPublicWebSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "HR Dev PublicWebSG "
      GroupName: "FinDevWebTierSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  FinDevAppPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "Fin Dev AppPrivateSG "
      GroupName: "FinDevAppPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  FinDevDBPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "Fin Dev DBPrivateSG "
      GroupName: "FinDevDBPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

#---------Apps within Staging Subnet-------------
#------------CRM Staging App----------------------
#------------CRM Staging EC2Web------------------

  CRMStagingEC2Web1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt StagingSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref StagingSubnet
      EbsOptimized: false

      SecurityGroupIds: 
        - !Ref CRMStagingPublicWebSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          sudo yum install python3-pip -y
          sudo pip3 install boto3
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Complex/createtable.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Add_multiple_items.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/dynamoscan.py -P /home/ec2-user
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${CRMStagingEC2Proc1.PrivateIp} 5000 -t 10 >> /tmp/Proc1.log") | crontab -
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet dropbox.com 443 -t 10 >> /tmp/dropbox.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Staging"
      - Key: "App"
        Value: "CRM"
      - Key: "Resource-ID"
        Value: "CRM-003-001"
      - Key: "Name"
        Value: "CRM-Staging-Web1"

#------------CRM Staging EC2ProcTiers------------------
  CRMStagingEC2Proc1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt StagingSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref StagingSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref CRMStagingAppPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 5000; done &
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${CRMStagingEC2DB1.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Staging"
      - Key: "App"
        Value: "CRM"
      - Key: "Resource-ID"
        Value: "CRM-003-002"
      - Key: "Name"
        Value: "CRM-Staging-Proc1"

#------------- CRM Staging Database----------------

  CRMStagingEC2DB1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt DevSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref DevSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref CRMStagingDBPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 3306; done &
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${FinanceEC2DB1.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Staging"
      - Key: "App"
        Value: "CRM"
      - Key: "Resource-ID"
        Value: "CRM-003-003"
      - Key: "Name"
        Value: "CRM-Staging-DB1"

#---------CRM Staging Security groups----------

  CRMStagingPublicWebSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "CRM Staging PublicWebSG "
      GroupName: "CRMStagingWebTierSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  CRMStagingAppPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "CRM Staging AppPrivateSG "
      GroupName: "CRMStagingAppPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  CRMStagingDBPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "CRM Staging DBPrivateSG "
      GroupName: "CRMStagingDBPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

#-----------Fin Staging App----------------------
#------------Fin Staging EC2Web------------------

  FinStagingEC2Web1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt StagingSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref StagingSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref FinStagingPublicWebSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          sudo yum install python3-pip -y
          sudo pip3 install boto3
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Complex/createtable.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/Add_multiple_items.py -P /home/ec2-user
          wget https://raw.githubusercontent.com/HerbyJ3/python_projects/main/Week14/dynamoscan.py -P /home/ec2-user
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${FinStagingEC2Proc1.PrivateIp} 5000 -t 10 >> /tmp/Proc1.log") | crontab -
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet dropbox.com 443 -t 10 >> /tmp/dropbox.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Staging"
      - Key: "App"
        Value: "Finance"
      - Key: "Resource-ID"
        Value: "Fin-003-001"
      - Key: "Name"
        Value: "Fin-Staging-Web1"

#------------Fin Staging EC2ProcTiers------------------
  FinStagingEC2Proc1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt StagingSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref StagingSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref FinStagingAppPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 5000; done &
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${FinStagingEC2DB1.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
          (crontab -l 2>/dev/null || echo ""; echo "* * * * *  telnet ${CRMEC2DB1.PrivateIp} 3306 -t 10 >> /tmp/DB.log") | crontab -
      Tags:
      - Key: "Env"
        Value: "Staging"
      - Key: "App"
        Value: "Finance"
      - Key: "Resource-ID"
        Value: "Fin-003-002"
      - Key: "Name"
        Value: "Fin-Staging-Proc1"

#------------- Fin Staging Database----------------

  FinStagingEC2DB1:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref DefaultAMI
      InstanceType: "t2.micro"
#      KeyName: "freetrial"
      AvailabilityZone: !GetAtt DevSubnet.AvailabilityZone
      Tenancy: "default"
      SubnetId: !Ref DevSubnet
      EbsOptimized: false
      SecurityGroupIds: 
        - !Ref FinStagingDBPrivateSG
      SourceDestCheck: true
      HibernationOptions: 
        Configured: false
      EnclaveOptions: 
        Enabled: false
      UserData: 
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo yum update -y
          sudo yum install -y httpd
          sudo systemctl start httpd
          sudo systemct enable httpd
          sudo yum install telnet -y
          sudo yum install cronie -y
          sudo yum install nc -y
          sudo yum install python3-pip -y
          pip3 install boto3
          pip install amazon-dax-client
          wget http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/samples/TryDax.zip
          unzip TryDax.zip
          sudo systemctl enable crond.service
          sudo systemctl start crond.service
          while true; do nc -l -p 3306; done &
      Tags:
      - Key: "Env"
        Value: "Staging"
      - Key: "App"
        Value: "Finance"
      - Key: "Resource-ID"
        Value: "Fin-003-003"
      - Key: "Name"
        Value: "Fin-Staging-DB1"

#---------Fin Staging Security groups----------

  FinStagingPublicWebSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "Fin Staging PublicWebSG "
      GroupName: "FinStagingWebTierSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  FinStagingAppPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "Fin Staging AppPrivateSG "
      GroupName: "FinStagingAppPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"

  FinStagingDBPrivateSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "Fin Staging DBPrivateSG "
      GroupName: "FinStagingDBPrivateSG"
      VpcId: !Ref ACMEVPC
      SecurityGroupIngress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"
      SecurityGroupEgress: 
        - 
          CidrIp: "0.0.0.0/0"
          IpProtocol: "-1"